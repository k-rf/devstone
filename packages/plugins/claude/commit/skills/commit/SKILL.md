---
name: commit
description: "コミット、変更のコミット、コミット分割、差分レビューしてコミット、コミット計画、単一責任でのコミット、依存関係順序でのコミットなどをユーザーが求めた際に使用されるスキル。インタラクティブなコミットワークフローを提供する。"
allowed-tools: Bash(git *), Read, Glob, Grep, Task, AskUserQuestion
---

# コミットワークフロー

差分レビュー・コミット計画・実行の一連のインタラクティブワークフローを実行する。

## Step 0: 設定の読み込み

`.claude/configs/commit.json` が存在する場合、JSON からコミットスタイルと言語設定を抽出し、`commit-planner` エージェントに渡す。
ファイルが存在しない場合、デフォルト値（`gitmoji`、`en`）を使用する。

## Step 1: 差分レビュー

`diff-reviewer` エージェントを使用して現在の変更を分析する。

検出結果を深刻度別に整理してユーザーに提示する：

- **Critical** — コミット前に修正が必須
- **Warning** — 対処すべき
- **Informational** — 参考情報

続行前にユーザーの確認を得る。

## Step 2: コミット計画

`commit-planner` エージェントを使用してコミット計画を作成する。
設定済みのコミットスタイルと言語設定を渡す。

エージェントは以下の原則を適用する：

- **単一責任**: 各コミットはちょうど1つの論理的変更を表す
- **依存関係順序**: すべての中間状態が有効でなければならない

計画をユーザーに提示し、承認を得る。

## Step 3: 実行

承認された計画の各コミットについて：

1. ステージ対象のファイルとコミットメッセージを表示する
2. 特定のパスでファイルをステージする（`git add -A` は使わない）
3. パーシャルステージングが必要な場合：
   - ファイルの最終状態を一時的な場所に保存する
   - HEAD から復元し、このコミットの変更のみを適用する
   - 中間状態をステージする
   - コミット後に最終状態を復元する
4. `package.json` の変更時は `pnpm install` を実行して lockfile を再生成する
5. HEREDOC 形式でコミットを作成する：

   ```bash
   git commit -m "$(cat <<'EOF'
   <message>
   EOF
   )"
   ```

6. 成功を報告し、次のコミットに進む

全コミット完了後、`git log --oneline` で結果を表示する。

### Git 安全規則

- force push、reset --hard、フックのスキップは禁止
- 明示的に要求されない限り、以前のコミットの amend は禁止
- `git add -A` より特定のファイル指定を優先する
- 機密ファイル（.env、credentials）のコミットは禁止
