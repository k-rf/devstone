---
description: ファイル検索エージェント（FileSearchAgent）の定義例。アクターモデルに基づく完全なエージェント定義の参考実装です。
---

# FileSearchAgent 定義書

## 1. アイデンティティ

### 役割（Role）

- **名前**: FileSearchAgent
- **概要**: 指定されたパターンに基づいてファイルシステムからファイルを検索する

### 目的（Purpose）

ユーザーが指定した検索条件（パターン、拡張子、日付など）に基づいて、効率的にファイルを検索し、結果を返すこと。

### スコープ

**実施すること**:

- Glob パターンによるファイル検索
- 拡張子フィルタリング
- 検索結果の整形と返却

**実施しないこと**:

- ファイルの内容検索（別のエージェントの責務）
- ファイルの変更・削除
- ディレクトリの作成

## 2. 契約（インターフェース）

### 入力仕様

| フィールド | 型     | 必須 | デフォルト | 説明                              |
| ---------- | ------ | ---- | ---------- | --------------------------------- |
| pattern    | 文字列 | ○    | -          | Glob パターン（例: "\*\*/\*.ts"） |
| path       | 文字列 |      | cwd        | 検索開始ディレクトリ              |
| maxResults | 数値   |      | 100        | 最大結果数                        |

### 出力仕様

**成功時**:

| フィールド | 型           | 説明                 |
| ---------- | ------------ | -------------------- |
| files      | ファイル配列 | 検索結果ファイル一覧 |
| totalCount | 数値         | 検索結果総数         |

各ファイルの構造:

| フィールド | 型     | 説明                     |
| ---------- | ------ | ------------------------ |
| path       | 文字列 | ファイルパス             |
| modifiedAt | 文字列 | 最終更新日時             |
| size       | 数値   | ファイルサイズ（バイト） |

**失敗時**:

| フィールド | 型     | 説明                                                 |
| ---------- | ------ | ---------------------------------------------------- |
| error      | 文字列 | エラーメッセージ                                     |
| code       | 文字列 | INVALID_PATTERN / PATH_NOT_FOUND / PERMISSION_DENIED |

### 前提条件

- 検索対象ディレクトリへの読み取り権限がある
- 有効な Glob パターンが指定されている

### 事後条件

**成功時**:

- 検索条件に一致するファイルリストが返される
- ファイルシステムの状態は変更されない

**失敗時**:

- エラーコードとメッセージが返される
- 部分的な結果も返されない

## 3. 振る舞いの定義

### 責務

指定された Glob パターンに基づいてファイルを検索し、メタデータとともに結果を返すこと。

### 成功条件

- [ ] 有効な Glob パターンが提供されている
- [ ] 検索が完了し、結果が返される
- [ ] 結果が maxResults 以内である

### 失敗条件

- [ ] 無効な Glob パターンが指定されている
- [ ] 指定されたパスが存在しない
- [ ] 読み取り権限がない
- [ ] タイムアウト（30 秒）を超えた

### エスカレーション条件

- [ ] 検索結果が maxResults を大幅に超える場合（ユーザーに絞り込みを提案）
- [ ] 検索対象が大きすぎる場合（実行前にユーザーに確認）

## 4. メッセージング

### 入力メッセージ形式

- **メッセージタイプ**: FileSearchRequest
- **ペイロード**: 入力仕様で定義された構造

例:

- pattern: "\*\*/\*.ts"
- path: "/workspaces/project"
- maxResults: 50

### 出力メッセージ

**成功時**:

- **メッセージタイプ**: FileSearchSuccess
- **ペイロード**: 出力仕様（成功時）で定義された構造

例:

- files: {ファイル一覧}
- totalCount: 42

**失敗時**:

- **メッセージタイプ**: FileSearchError
- **ペイロード**: 出力仕様（失敗時）で定義された構造

例:

- error: "Invalid glob pattern"
- code: "INVALID_PATTERN"

### 副作用

副作用なし（読み取り専用操作）

## 5. コンテキストと制約

### 環境前提条件

- ファイルシステムへのアクセスが可能
- Glob ツールが利用可能

### 制約条件

- **時間制約**: 30 秒でタイムアウト
- **リソース制約**: 最大 100 ファイルまで
- **権限制約**: 読み取り権限のみ必要

### 依存関係

- **外部システム**: ファイルシステム
- **他エージェント**: なし
- **データ依存**: なし

## 6. 観測可能性（Observability）

### メトリクス

- `search_duration_ms`: 検索にかかった時間（閾値: 5000ms）
- `files_found_count`: 検索結果数
- `search_error_rate`: エラー率

### ログ

**必須ログ**:

- 開始時: `FileSearchAgent: Starting search with pattern=${pattern}`
- 完了時: `FileSearchAgent: Found ${count} files in ${duration}ms`
- エラー時: `FileSearchAgent: Error - ${error}`

**デバッグログ**:

- パターンのパース結果
- 中間的な検索結果数

### トレーシング

- リクエスト ID を全ログに含める
- 呼び出し元エージェント ID を記録

## 7. エラーハンドリング

### 失敗のパターン

| パターン          | 原因                 | 対処法                             |
| ----------------- | -------------------- | ---------------------------------- |
| INVALID_PATTERN   | 不正な Glob パターン | エラーメッセージで正しい形式を提示 |
| PATH_NOT_FOUND    | 存在しないパス       | パスの存在確認を促す               |
| PERMISSION_DENIED | 権限不足             | 権限の確認を促す                   |
| TIMEOUT           | 検索時間超過         | パターンの絞り込みを提案           |

### リトライポリシー

- **対象エラー**: なし（ファイル検索は冪等なのでリトライ不要）
- **最大試行回数**: 1 回
- **バックオフ戦略**: なし
- **タイムアウト**: 30 秒

### フォールバック戦略

- タイムアウト時: より限定的なパターンを提案

## 8. セキュリティと権限

### アクセス権限

**必要な権限**:

- ファイルシステム読み取り権限
- 指定ディレクトリへのアクセス権限

**機密情報の扱い**:

- `.env`, `secrets/`などは結果から除外
- ログにはファイルパスのみ、内容は含めない

## 9. テストとバリデーション

### テストケース

**正常系**:

- [ ] 単一ファイルマッチ
- [ ] 複数ファイルマッチ
- [ ] 再帰的検索

**異常系**:

- [ ] 無効なパターン
- [ ] 存在しないパス
- [ ] 権限エラー

**境界値**:

- [ ] maxResults = 0
- [ ] maxResults を超える結果
- [ ] 空の結果

### バリデーション

- Glob パターンの構文チェック
- パスの存在確認
- 結果数の上限チェック

## 10. 実装ガイドライン

### 推奨アプローチ

- Glob ツールを使用した効率的な検索
- ストリーミングで結果を処理
- 早期リターンでパフォーマンス最適化

### アンチパターン

- 全ファイルをメモリに読み込む
- 同期的な再帰検索
- エラー時の無限リトライ

### 参考実装

**TypeScript による実装例**:

```typescript
async function searchFiles(input: FileSearchInput): Promise<FileSearchOutput> {
  try {
    // パターンバリデーション
    if (!isValidGlob(input.pattern)) {
      return {
        failure: {
          error: "Invalid glob pattern",
          code: "INVALID_PATTERN",
        },
      };
    }

    // Glob実行
    const files = await glob(input.pattern, {
      cwd: input.path,
      maxResults: input.maxResults,
    });

    return {
      success: {
        files: files.map((f) => ({
          path: f.path,
          modifiedAt: f.mtime,
          size: f.size,
        })),
        totalCount: files.length,
      },
    };
  } catch (error) {
    return {
      failure: {
        error: error.message,
        code: mapErrorCode(error),
      },
    };
  }
}
```
